<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chat App - Full</title>
    <style>
        body { font-family: sans-serif; background: #e5ddd5; margin: 0; display: flex; justify-content: center; height: 100vh; }
        .container { width: 100%; max-width: 450px; background: white; display: flex; flex-direction: column; height: 100%; position: relative; }

        /* Login Screen */
        #login-screen {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: white; z-index: 10; display: flex;
            flex-direction: column; justify-content: center; align-items: center; text-align: center;
        }
        .btn-google { background: #4285F4; color: white; border: none; padding: 10px 20px; border-radius: 5px; font-weight: bold; cursor: pointer; margin-top: 10px; }

        /* App Screen */
        #app-screen { display: none; flex-direction: column; height: 100%; }
        
        /* Header */
        header { background: #008069; color: white; padding: 10px 15px; display: flex; justify-content: space-between; align-items: center; }
        .user-details { font-size: 13px; }
        .uid-copy { font-family: monospace; background: rgba(0,0,0,0.2); padding: 2px 5px; border-radius: 3px; cursor: pointer; }
        .btn-logout { background: none; border: 1px solid white; color: white; border-radius: 3px; cursor: pointer; font-size: 11px; padding: 5px; }

        /* Input ID Teman */
        .friend-input-area { background: #f0f0f0; padding: 10px; display: flex; gap: 5px; border-bottom: 1px solid #ddd; }
        .friend-input-area input { flex: 1; padding: 8px; border: 1px solid #ccc; border-radius: 20px; outline: none; }
        .friend-input-area button { background: #008069; color: white; border: none; padding: 8px 15px; border-radius: 20px; cursor: pointer; }

        /* Area Chat */
        #chat-container { flex: 1; overflow-y: auto; padding: 10px; display: flex; flex-direction: column; gap: 10px; background: #e5ddd5; }
        .bubble { max-width: 70%; padding: 8px 12px; border-radius: 8px; font-size: 14px; line-height: 1.4; position: relative; word-wrap: break-word; }
        
        .bubble.me { align-self: flex-end; background: #d9fdd3; border-radius: 8px 0 8px 8px; }
        .bubble.them { align-self: flex-start; background: white; border-radius: 0 8px 8px 8px; }
        
        .bubble .sender { font-size: 10px; color: #888; margin-bottom: 3px; display: block; font-weight: bold; }

        /* Kirim Pesan */
        .message-input-area { padding: 10px; background: #f0f0f0; display: flex; gap: 5px; }
        .message-input-area input { flex: 1; padding: 10px; border-radius: 20px; border: 1px solid #ccc; outline: none; }
        .message-input-area button { background: #008069; color: white; border: none; width: 40px; height: 40px; border-radius: 50%; cursor: pointer; }

        .hidden { display: none !important; }
    </style>
</head>
<body>

    <div class="container">
        <div id="login-screen">
            <h2>Chat App</h2>
            <p>Login biar ID gak berubah-ubah.</p>
            <button class="btn-google" onclick="loginGoogle()">Masuk dengan Google</button>
        </div>

        <div id="app-screen">
            <header>
                <div class="user-details">
                    <div id="my-name">Loading...</div>
                    <div id="my-uid" class="uid-copy" onclick="copyUID()">UID: ... (Klik Copy)</div>
                </div>
                <button class="btn-logout" onclick="logoutGoogle()">Keluar</button>
            </header>

            <div class="friend-input-area">
                <input type="text" id="friend-id-input" placeholder="Masukkan UID Teman disini...">
                <button onclick="setLawanBicara()">Mulai</button>
            </div>

            <div id="chat-container">
                <div style="text-align:center; color:#888; font-size:12px; margin-top:20px;">
                    Belum ada chat. Masukkan UID teman di atas untuk mulai.
                </div>
            </div>

            <div class="message-input-area">
                <input type="text" id="msg-input" placeholder="Ketik pesan...">
                <button onclick="kirimPesan()">âž¤</button>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.17.1/firebase-app.js";
        import { getAuth, signInWithPopup, GoogleAuthProvider, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/9.17.1/firebase-auth.js";
        import { getDatabase, ref, push, onChildAdded, serverTimestamp } from "https://www.gstatic.com/firebasejs/9.17.1/firebase-database.js";

        // =======================================================
        // PASTE CONFIG FIREBASE KAMU DISINI (YANG TADI)
        // =======================================================
        const firebaseConfig = {
            apiKey: "AIzaSyDHd3g5X-nJpeW5bvd4tdCp1fdv8nvqsn4",
              authDomain: "whatsapp-clone-e158f.firebaseapp.com",
              projectId: "whatsapp-clone-e158f",
              storageBucket: "whatsapp-clone-e158f.firebasestorage.app",
              messagingSenderId: "544454324372",
              appId: "1:544454324372:web:011c4b6ddaa3d053318481",
            databaseURL: "https://whatsapp-clone-e158f-default-rtdb.asia-southeast1.firebasedatabase.app/" // <-- Pastikan ini ada!
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getDatabase(app);
        const provider = new GoogleAuthProvider();

        let myUID = null;
        let myName = null;
        let friendUID = null; // ID Teman yang sedang dichat

        // --- AUTHENTICATION ---
        window.loginGoogle = () => signInWithPopup(auth, provider);
        window.logoutGoogle = () => signOut(auth).then(() => location.reload());

        onAuthStateChanged(auth, (user) => {
            if (user) {
                myUID = user.uid;
                myName = user.displayName;
                
                document.getElementById('login-screen').classList.add('hidden');
                document.getElementById('app-screen').style.display = 'flex';
                document.getElementById('my-name').innerText = myName;
                document.getElementById('my-uid').innerText = "UID Saya: " + myUID;
            }
        });

        // --- LOGIKA CHAT ---
        
        // 1. Set Teman Bicara
        window.setLawanBicara = () => {
            let inputVal = document.getElementById('friend-id-input').value.trim();
            if(!inputVal) return alert("Isi UID teman dulu!");
            if(inputVal === myUID) return alert("Jangan chat diri sendiri, nanti gila.");
            
            friendUID = inputVal;
            alert("Mulai chat dengan UID: " + friendUID);
            
            // Bersihkan layar chat dulu
            document.getElementById('chat-container').innerHTML = '';
            
            // Load Chat (Dengar pesan masuk)
            loadChat();
        };

        // 2. Kirim Pesan
        window.kirimPesan = () => {
            let msg = document.getElementById('msg-input').value;
            if(!msg || !friendUID) return;

            // Simpan di Database (Room ID = gabungan 2 UID biar unik)
            // Kita pakai cara simpel: RoomID = UID_KECIL + UID_BESAR (biar urutannya selalu sama)
            let roomID = [myUID, friendUID].sort().join('_');

            push(ref(db, 'chats/' + roomID), {
                sender: myUID,
                senderName: myName,
                text: msg,
                timestamp: serverTimestamp()
            });

            document.getElementById('msg-input').value = ''; // Kosongkan input
        };

        // 3. Terima Pesan (Realtime)
        function loadChat() {
            let roomID = [myUID, friendUID].sort().join('_');
            const chatRef = ref(db, 'chats/' + roomID);

            onChildAdded(chatRef, (snapshot) => {
                const data = snapshot.val();
                renderBubble(data.text, data.sender === myUID ? 'me' : 'them', data.senderName);
                
                // Auto scroll ke bawah
                const container = document.getElementById('chat-container');
                container.scrollTop = container.scrollHeight;
            });
        }

        function renderBubble(text, type, senderName) {
            const div = document.createElement('div');
            div.className = `bubble ${type}`;
            div.innerHTML = `<span class="sender">${senderName}</span>${text}`;
            document.getElementById('chat-container').appendChild(div);
        }
        
        // Fitur Copy UID
        window.copyUID = () => {
            navigator.clipboard.writeText(myUID);
            alert("UID disalin!");
        }
    </script>
</body>
</html>

