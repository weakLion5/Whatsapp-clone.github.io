<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WhatsApp Clone</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Helvetica, Arial, sans-serif;
        }

        body {
            background-color: #d1d7db;
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
        }

        /* Login Screen Overlay */
        #loginScreen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: #f0f2f5;
            z-index: 9999;
            display: flex;
            justify-content: center;
            align-items: center;
            flex-direction: column;
            text-align: center;
        }

        .login-btn {
            padding: 12px 24px;
            background: #00a884;
            color: white;
            border: none;
            border-radius: 24px;
            cursor: pointer;
            font-size: 16px;
            font-weight: bold;
            margin-top: 20px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
            transition: 0.3s;
        }

        .login-btn:hover {
            background: #008f6f;
        }

        /* Container Aplikasi */
        .app-container {
            display: none; /* Default hidden sampai login */
            width: 100%;
            max-width: 1600px;
            height: 100vh;
            background-color: #fff;
            box-shadow: 0 1px 1px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        /* --- SIDEBAR --- */
        .sidebar {
            width: 30%;
            border-right: 1px solid #d1d7db;
            display: flex;
            flex-direction: column;
            background: white;
        }

        .header {
            height: 60px;
            background-color: #f0f2f5;
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0 15px;
        }

        .user-img img {
            width: 40px;
            height: 40px;
            border-radius: 50%;
        }

        .nav-icons i {
            color: #54656f;
            font-size: 20px;
            margin-left: 20px;
            cursor: pointer;
        }

        .chat-list {
            flex: 1;
            overflow-y: auto;
            background-color: #fff;
        }

        /* --- CHAT WINDOW --- */
        .chat-window {
            width: 70%;
            display: flex;
            flex-direction: column;
            background: #efeae2;
        }

        /* Chat Box Area */
        .chat-box {
            flex: 1;
            background-color: #efeae2;
            background-image: url('https://user-images.githubusercontent.com/15075759/28719144-86dc0f70-73b1-11e7-911d-60d70fcded21.png');
            background-size: 400px; /* Ukuran pattern */
            padding: 20px;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
        }

        .message {
            max-width: 65%;
            padding: 8px 12px;
            border-radius: 8px;
            margin-bottom: 8px;
            font-size: 14px;
            position: relative;
            line-height: 1.4;
            box-shadow: 0 1px 0.5px rgba(0,0,0,0.13);
        }

        .message.received {
            background-color: #fff;
            align-self: flex-start;
            border-top-left-radius: 0;
        }

        .message.sent {
            background-color: #d9fdd3;
            align-self: flex-end; /* Pesan sendiri di kanan */
            border-top-right-radius: 0;
        }

        .message .sender-name {
            font-size: 11px;
            font-weight: bold;
            color: #d85c2c;
            margin-bottom: 2px;
            display: block;
        }

        .message .time {
            float: right;
            margin-left: 10px;
            font-size: 10px;
            color: #667781;
            margin-top: 5px;
        }

        /* Input Area */
        .chat-input {
            height: 60px;
            background-color: #f0f2f5;
            display: flex;
            align-items: center;
            padding: 0 20px;
        }

        .chat-input input {
            flex: 1;
            border: none;
            padding: 12px;
            border-radius: 8px;
            margin: 0 10px;
            outline: none;
            font-size: 15px;
        }
        
        /* Responsive Mobile */
        @media (max-width: 700px) {
            .sidebar { display: none; } /* Sembunyikan sidebar di HP biar fokus chat */
            .chat-window { width: 100%; }
        }
    </style>
</head>
<body>

    <div id="loginScreen">
        <img src="https://upload.wikimedia.org/wikipedia/commons/thumb/6/6b/WhatsApp.svg/1200px-WhatsApp.svg.png" width="80" style="margin-bottom: 20px;">
        <h2>Selamat Datang di WA Clone</h2>
        <p style="color: #666;">Login dulu biar bisa chattingan sama yang lain</p>
        <button class="login-btn" onclick="loginGoogle()">
            <i class="fa-brands fa-google"></i> Login dengan Google
        </button>
    </div>

    <div class="app-container" id="appContainer">
        <div class="sidebar">
            <div class="header">
                <div class="user-img" id="myProfilePic">
                    </div>
                <div class="nav-icons">
                    <i class="fa-solid fa-users"></i>
                    <i class="fa-solid fa-message"></i>
                    <i class="fa-solid fa-ellipsis-vertical"></i>
                </div>
            </div>
            <div style="padding: 10px; background: #fff; height: 100%;">
                <h3 style="color:#008069; margin-bottom:10px;">Grup Publik Ngawi</h3>
                <p style="font-size:12px; color:#666;">Semua orang yang login akan chat di room ini.</p>
            </div>
        </div>

        <div class="chat-window">
            <div class="header">
                <div style="display:flex; align-items:center;">
                    <img src="https://ui-avatars.com/api/?name=Grup+Umum&background=random" style="width:40px; height:40px; border-radius:50%; margin-right:10px;">
                    <div>
                        <h4 style="font-size:16px;">Grup Komunitas</h4>
                        <p style="font-size:12px; color:#666;">Online</p>
                    </div>
                </div>
                <div class="nav-icons">
                    <i class="fa-solid fa-magnifying-glass"></i>
                    <i class="fa-solid fa-ellipsis-vertical"></i>
                </div>
            </div>

            <div class="chat-box" id="chatBox">
                </div>

            <div class="chat-input">
                <i class="fa-regular fa-face-smile" style="color:#54656f; font-size:24px; cursor:pointer;"></i>
                <input type="text" id="messageInput" placeholder="Ketik pesan">
                <i class="fa-solid fa-paper-plane" onclick="sendMessage()" style="color:#54656f; font-size:20px; cursor:pointer; margin-left:10px;"></i>
            </div>
        </div>
    </div>

    <script type="module">
        // Import Firebase dari CDN
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, signInWithPopup, GoogleAuthProvider, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, query, orderBy, onSnapshot, limit } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        // ==========================================================
        // ⚠️ GANTI KODE DI BAWAH INI DENGAN CONFIG FIREBASE KAMU ⚠️
        // ==========================================================
        const firebaseConfig = {
            apiKey: "AIzaSyDHd3g5X-nJpeW5bvd4tdCp1fdv8nvqsn4",
            authDomain: "whatsapp-clone-e158f.firebaseapp.com",
            projectId: "whatsapp-clone-e158f",
            storageBucket: "whatsapp-clone-e158f.firebasestorage.app",
            messagingSenderId: "544454324372",
            appId: "1:544454324372:web:011c4b6ddaa3d053318481"
        };
        // ==========================================================

        // Inisialisasi Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const provider = new GoogleAuthProvider();

        let currentUser = null;

        // Fungsi Login (ditempel ke window agar bisa dipanggil HTML)
        window.loginGoogle = () => {
            signInWithPopup(auth, provider)
                .then((result) => {
                    console.log("Login Berhasil");
                }).catch((error) => {
                    console.error("Login Gagal:", error);
                    alert("Gagal Login: " + error.message);
                });
        };

        // Cek Status Login Pengguna
        onAuthStateChanged(auth, (user) => {
            if (user) {
                currentUser = user;
                // Sembunyikan Login, Tampilkan Chat
                document.getElementById('loginScreen').style.display = 'none';
                document.getElementById('appContainer').style.display = 'flex';
                
                // Tampilkan foto profil user di sidebar
                const profileHTML = `<img src="${user.photoURL}" alt="Profile">`;
                document.getElementById('myProfilePic').innerHTML = profileHTML;

                // Load Chat
                loadMessages();
            } else {
                // Tampilkan Login, Sembunyikan Chat
                document.getElementById('loginScreen').style.display = 'flex';
                document.getElementById('appContainer').style.display = 'none';
            }
        });

        // Fungsi Kirim Pesan
        window.sendMessage = async () => {
            const input = document.getElementById('messageInput');
            const text = input.value;

            if (text.trim() === "") return;

            try {
                await addDoc(collection(db, "messages"), {
                    text: text,
                    name: currentUser.displayName,
                    photo: currentUser.photoURL,
                    uid: currentUser.uid,
                    createdAt: new Date()
                });
                input.value = ""; // Bersihkan input
            } catch (e) {
                console.error("Error kirim pesan: ", e);
            }
        };

        // Fungsi Baca Pesan Realtime
        function loadMessages() {
            const chatBox = document.getElementById('chatBox');
            // Ambil 50 pesan terakhir, urutkan berdasarkan waktu
            const q = query(collection(db, "messages"), orderBy("createdAt"), limit(50));

            onSnapshot(q, (snapshot) => {
                chatBox.innerHTML = ""; // Bersihkan chat box sebelum render ulang
                
                snapshot.forEach((doc) => {
                    const msg = doc.data();
                    const isMe = msg.uid === currentUser.uid;
                    
                    // Format waktu sederhana
                    let timeString = "";
                    if (msg.createdAt) {
                        const date = msg.createdAt.toDate();
                        timeString = date.getHours() + ":" + String(date.getMinutes()).padStart(2, '0');
                    }

                    // Buat elemen chat
                    const div = document.createElement('div');
                    div.className = `message ${isMe ? 'sent' : 'received'}`;
                    
                    // Isi HTML pesan
                    let nameTag = isMe ? '' : `<span class="sender-name">${msg.name}</span>`;
                    
                    div.innerHTML = `
                        ${nameTag}
                        <p>${msg.text}</p>
                        <span class="time">${timeString}</span>
                    `;
                    
                    chatBox.appendChild(div);
                });

                // Auto Scroll ke bawah
                chatBox.scrollTop = chatBox.scrollHeight;
            });
        }

        // Fitur tekan Enter untuk kirim
        document.getElementById('messageInput').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                window.sendMessage();
            }
        });
    </script>
</body>
</html>
